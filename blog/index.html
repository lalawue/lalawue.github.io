<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>Sucha's Blog - Welcome</title>
    <meta name="generator" content="MarkdownProjectCompositor.lua" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="Sucha" />
    <meta name="keywords" content="suchang, programming, GNU, Linux, Emacs, Lua" />
    <meta name="description" content="Sucha's blog" />
    <link rev="made" href="mailto:suchaaa@gmail.com" />
    <link rel="shortcut icon" href="../images/ico.png" />
    <link rel="stylesheet" type="text/css" href="../styles/blog.css" />
    <!--[if lte IE 6]><link rel="stylesheet" type="text/css" href="../styles/ie.css" /><![endif]-->
  </head>
  <body>
    <div id="body">
      <div id="text">
	<!-- Page published by cmark-gfm begins here --><h1>Sucha's Blog ~ Welcome</h1><div class="date">19年11月10日 周日 23:25</div>
<h2>玉龙雪山</h2>
<p>说起十一到丽江玉龙雪山，从买票开始就得注意，到顶峰的大索道票，记得是需要在公众号当天抢的。我买的是套票，不需要抢票，保证出票，但不便宜。</p>
<p>听客栈老板说，有些年高峰期时(2号、3号)，即便套票，四百多能炒到一千多。今年十一后半期天气不好，价格没有那么高，也不便宜。</p>
<p>套票包含了印象丽江实景舞台剧，在风雨中开场，在风雨中结束。观众席上的我们，穿着借用自官方的雨衣，看完了整场。印象？是雨，是雨，还是雨。</p>
<p>听导游的话，6点多就在古城南门等着了。但索道票买的时候就确定了上山的时间，我们搭索道是在下午2点多，因为要赶晚上的火车，留给我登顶的时间有限。</p>
<p>套票包含了保暖防风大衣和一个小氧气罐。实话说，没有氧气罐，在4千多米海拔，我是挪不动的，但有了氧气罐后也只是好点。</p>
<p>因为天气不好，搭上索道后就看不到什么东西了，反正看不远，一片雾蒙蒙，一瞬间有露出些许阳光，勾勒了顶峰的轮廓，但没能抓拍下来。</p>
<p>那天玉龙雪山的美，适合留在记忆中。</p>
<p>还是说下丽江到昆明的火车吧，我搭的K9618，软座其实跟动车的一等座一样，晚上19点48开，到昆明是早上5点。</p>
<p>我睡得不好，半夜2点半看手机，发现火车已在昆明西站了，一直等到快5点，才又继续出发到昆明站。所以，这辆车虽然终点站是曲靖，但其实为昆明的广大乘客考虑了很多呀。</p>
<p>这趟火车，还连接了我早上8点的飞机。之前还想着怎么从昆明火车站到机场，后来发现想多了。4点47分到了昆明站，空港快线的候机厅就在站内，连闸机口都不用出。而第一班空港快线，就是5点。</p>
<p>稍微有点不方便的是，因为不到5点，空港快线的票只能现金买，5点后才能用电子支付。</p>
<p>不管怎样，行程挺顺利的，还省了一个晚上的住宿费。只是熬过的夜，只有头发才知道了。</p>
<div class="category"><a href="CategoryLife.html">CategoryLife</a> / <a href="2019-11.html#p0">Permalink</a></div>

<div class="date">19年10月29日 周二 23:46</div>
<h2>泸沽湖</h2>
<p>计划了泸沽湖2天的行程，美团上订了散客票，等来了陌生的电话，却没等到师傅晚上9点半的通知。陌生的电话再也联系不上，只好找美团客服，还好，师傅的电话在10点准时来了，车牌号是要不到的，只约了明早的时间地点。</p>
<p>丽江到泸沽湖的路还行，一般4个小时可以到，听说极端情况下下雨塌方就不好说了。不过泸沽湖一般计划2天，一天来回时间太赶，而且买散客票的时候师傅就会告知无法一天来回，反正你的票当天是不能回丽江的。</p>
<p>司机和导游都是泸沽湖本地摩梭人，导游是又帅又会说话，在车上就开始推销环岛游，包一个本地特色晚餐(自家亲戚的)，以及一个篝火晚会的票。对我这种散客来说，特色餐太有吸引力了，而且，让我下车后再去拼车，总担心浪费时间。，而环岛怎么样都是玩，差别不大。</p>
<p>包车当然是极好的，可是财力不允许呀[泪]</p>
<p>说到住宿，泪又开始流。泸沽湖地处云南、四川交界，分界线大概是图一的中间，住宿，选大洛水就好了，商家众多，可选的也多，还是散客集合的中心。我不巧算是住在了靠近湖心的尖角一端，地处四川界，第二天还得多花钱拼车回到大洛水。</p>
<p>也是跟拼车师傅的聊天，了解到两省对开发保护泸沽湖的不同，四川已不允许新建民宿，原来民宿的修缮、改建也受限，所以新建的条件较好的大一点的酒店民宿，都在云南这一面，几乎可以认为都在大洛水了。</p>
<p>我住的就是那种三层的木板特色民宿，价钱美丽，晚上风大还有点吵，想哭。</p>
<p>还好泸沽湖行程的第一天天气特别好，湖水清澈美到了极点，大大超出了我的预期，随便一拍都是桌面壁纸，后期？不存在的。</p>
<p>特色餐也不错，草帽锅盖，试着拿了一下，特别地重，也算是是草帽的完美伪装了。导游小声说鱼肉不够还可以加，管够管饱，只是酒太烈了接受不能。</p>
<p><a href="http://t.cn/Ai1aHTzd?m=4432185656045387&amp;u=1869398464">泸沽湖划船 视频</a></p>
<p><a href="http://t.cn/Ai1aTuok?m=4432184813013528&amp;u=1869398464">泸沽湖全景 视频</a></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da8v3qjuj21400u0agv.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da8vsa8ij21400u015q.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da8wcph7j21400u0anw.jpg" width=240></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da91o8iij21400u011n.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da8ukk6yj21400u0qfu.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da928xjbj21400u0wq0.jpg" width=240></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da94irmnj21400u0nae.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da95bwudj21400u07hm.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da96v0rpj20u0140wqg.jpg" width=180></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da97zyhbj21400u0wt8.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da932bm9j21400u07jc.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da98sokej21400u015z.jpg" width=240></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da999v96j21400u046j.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da9a2haaj21400u0afz.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da9aoowtj21400u0dov.jpg" width=240></p>
<img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8da9b6mekj21400u0qa3.jpg" width=240>
<div class="category"><a href="CategoryLife.html">CategoryLife</a> / <a href="2019-10.html#p3">Permalink</a></div>

<div class="date">19年10月21日 周二 23:39</div>
<h2>丽江古城</h2>
<p>大理到丽江动车2、3个小时，票好买，也不贵。相比大理，丽江热闹多了，毕竟这算是一个旅行中转站，到玉龙雪山、泸沽湖、香格里拉，各种团、各种车都很多。</p>
<p>说到丽江住宿，也有几滴眼泪可以说一下。比如住宿地点的选择，尽量都住在丽江古城这一片，后面的参团、拼车等等，师傅说会去搭你，基本上认为你在丽江古城这一圈。</p>
<p>还有，尽量不要住在古城西面，因为古城不是平地，西面是高点狮子山，住在这边进出古城就要爬山了。虽然高点可以看古城夜景，但丽江古城海拔2400，范围也要比大理古城大多了，一天很难逛完。再说在丽江的这几天，肯定会多次进出古城，每次都爬这个山，心跳明显加速。</p>
<p>我后面住在了南门，相比之下，又热闹又方便。</p>
<p>还有，大理古城里面我不会迷路，横七竖八、东西南北错不了。但在丽江古城，不看地图，很容易就走偏了，[允悲]。毕竟是那种弯曲小巷串起来的古城。</p>
<p>古城里面人是真多，酒吧街什么接踵摩肩是有的，那种窄巷人流，是期待中国庆的感觉。</p>
<p>说到从美团买票参团后，一般会有个手机号打电话给你，叫你晚上9点半后注意开车师傅的电话，师傅一般不会把车牌号告诉你，只会跟你确认明早接你的地点，一般就在古城南门、北门这一圈标志性建筑之类，明早就等吧。</p>
<p>感觉他们不到最后一刻，具体哪辆车该接哪些同学，是不确定的。估计是到晚上9点半10点才能确定某条线路具体有哪些同学，搜集整理后，分给各个司机导游，然后才会各个电话通知。</p>
<p>其实这对于买散客票的人，有些忐忑，因为到晚上10点，第二天的行程都未能确定，就担心早起梦游的我，无车可搭，又逛了一天古城。</p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547rep1ej21400u0gsb.jpg" width=260> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547s0iw5j21400u0n0e.jpg" width=280> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547sr6aqj20u01407c9.jpg" width=200></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547te9dqj20u0140te9.jpg" width=200> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547u0legj20u00u0qaa.jpg" width=240> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547ulv9dj21400u0jzl.jpg" width=300></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547v7rh5j20u00u0gvs.jpg" width=260> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547vmuz1j20u0140tdj.jpg" width=200> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g8547w3v64j20u0140ahk.jpg" width=200></p>
<div class="category"><a href="CategoryLife.html">CategoryLife</a> / <a href="2019-10.html#p2">Permalink</a></div>

<div class="date">19年10月16日 周日 23:32</div>
<h2>新浪图床</h2>
<p>从 weibo 里面拷贝 URL 出来，实际上是不能直接访问的，因为需要账号的 cookie 信息，但奇怪的是，来自于这个网址 https://www.bitu.net/ 介绍，新浪图床只要将前缀 wx + 数字，替换为 tva1 就可了，亲测，有效，：)</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2019-10.html#p1">Permalink</a></div>

<div class="date">19年10月15日 周日 23:15</div>
<h2>苍山洱海</h2>
<p>十一的第一站是大理，因为各种原因，从昆明西部客运站花了差不多7个小时才到大理县城，然后近一个小时公交才到大理古城，天都黑了。</p>
<p>古城不算小，靠近西门、南门比较热闹，几条商业街都在这边，各种肯德基、麦当劳都有，像极了深圳的东门，老城的商业街。找个店试了一碗米线，还不如深圳的好吃。还有一条酒吧街，外面听着轰轰轰挺热闹的，虽然写着没有低消，感觉人没有很多。北门那边多是各种各样的民宿，晚上路过的街边是热火朝天的火锅、烧烤，穿过那一片后，相比南门、西门，安静多了。</p>
<p>哦，还有，离开热闹商业片区后的奶茶很便宜，大杯，不到10块，没错，是加盟店的味道……</p>
<p>靠近古城的苍山才是这次出行的重点，感通寺索道上山后的旅行步道是海拔2600米，古城海拔2000左右。天气不错，可以看到一点洱海。传统路线，在七龙女池索道上山顶，到了3900后，只能慢慢走了。山顶云雾浓厚，看不远，眼前的洗马潭就是一个小水潭，季节未到吧，没有雪。在游客中心瞥了一眼山顶，算是见到了真容。</p>
<p>没待太久就下山了，过了云层的山腰已是阳光明媚。掉头去看了三塔，¥75的门票太贵，虽然景区很大，但除了三塔，其他感觉都是新建的，凑上了规模，觉得很勉强。</p>
<p>可以在美团买游洱海的大船票，大理港上船，桃源码头收队，全程3个半小时左右。回港的车票得提前在港口买，因为回程人满了就没票了，得走一阵到外面搭散客的车，旺季吧，车挺多的。</p>
<p>早上的苍山像在蓝天下盖了一层厚厚的鸭绒被，被子在金黄的山体上滑动。洱海水面开阔，天蓝湖蓝快要连成一线。就是早上的风有点冷，后面太阳拉高后，又贼热。</p>
<p>3个多小时的船程，中间一个湖岩小普陀有点意思，大概300平方左右吧，还建了一个小庙，平地挤满了商贩摊子，有点微小精致的感觉。</p>
<p>吸收了大巴票的教训，下船后赶动车去了。</p>
<h3>视频及配图</h3>
<p>不晓得视频和图片能撑到什么时候。</p>
<p><a href="http://t.cn/AiuQJjgA?m=4427094442046626&amp;u=1869398464">Video Link</a></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzravs1pj20u00u010s.jpg" width=220> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzrcxs2cj21400u07f3.jpg" width=280> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzr7fscjj20u01407hr.jpg" width=200></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzrgqvpbj21400u0n71.jpg" width=280> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzricmc6j21400u0gqx.jpg" width=280> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzrjw3h8j20u0140487.jpg" width=200></p>
<p><img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzro8798j20u0140jxb.jpg" width=200> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzrsjdt2j21400u0dli.jpg" width=280> <img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1g7wzruyf09j21400u0dlz.jpg" width=280></p>
<div class="category"><a href="CategoryLife.html">CategoryLife</a> / <a href="2019-10.html#p0">Permalink</a></div>

<div class="date">19年9月22日 周日 09:00</div>
<h2>安利新手机失败了</h2>
<p>去年买了一加 6T，然后今年又换了一加 7 Pro，想着把 6T 换给家里人用，之前家里人用的一直是华为。在我看来，一加相比华为，少了一些琐琐碎碎的也许用不到的功能，但是屏幕以及除人像之外的相机，其实是有优势的。</p>
<p>但是给老爸用了不到半天，就说这个应该怎么传照片、视频呀，他会拍很多的照片、视频，而且还要传到电脑端来保存。</p>
<ul>
<li>方案一，是使用无线的比如爱莫助手，但是 WIFI 传输速度很不理想，而且打包方式的下载其实也不好用</li>
<li>方案二，尝试使用华为的电脑手机套件——华为手机助手，可是呢，眼看着app安装到了手机上后，一下就又消失了</li>
<li>方案三，使用应用宝的电脑手机套件——也不知道是不是驱动问题，连接很不稳定，相册内容几乎读不出来</li>
</ul>
<p>其实还有复杂一些的比如 MTP 传输，但是对于老人来说，要记住相册目录什么的，相比有电脑套件，只关注相册、视频内容，更直观的方式来操作，真的差了很多。</p>
<p>所以，最后是安利失败，只好把这台 6T 二手掉吧，新手机应该只会考虑华为了。</p>
<div class="category"><a href="CategoryMisc.html">CategoryMisc</a> / <a href="2019-09.html#p0">Permalink</a></div>

<div class="date">19年8月25日 周日 22:50</div>
<h2>获取天气信息</h2>
<p>写了几个脚本程序，通过 Lua 的 os.execute() 命令走批处理，下载后解析获取几个大城市的天气信息，再将其存储到 sqlite3 里面。</p>
<p>忘记之前从哪个博客看到别人搜集了好多 PM2.5 的数据，然后做成了图表，觉得是比较好玩了。</p>
<p>用的都是快糙猛的方法，比如下载用的就是 curl，用 Lua 做了个配置文件，设置了好几个城市的 URL；解压用的是 gzip，解析用的 gumbo，文件列表依赖 LuaFileSystem，后面这两个其实不太好，因为我使用的系统跨度太大了。</p>
<p>比如在我的 Ubuntu 12.04.5 LTS 里，gumbo 直接使用 Luarocks 编译不出来，得手工处理，拷贝 .so 库什么的。反而是数据库接口，使用了依赖 LuaJIT FFI 的 lsqlite3 来做数据库的写入更新，这个倒是不错，没有那么多的问题。</p>
<p>非 LuaJIT 的 Lua C 库，需要不同版本的 Lua 头文件，以及对应的 C 文件来对接 Lua VM 做数据输入输出，蛋疼的是 gumbo，甚至需要 pkg-config 指出 Lua 信息，在上面的 Ubuntu 版本里面，得自己编写 lua.pc 放到 pkgconfig 目录下面。反观 LuaJIT，有了 FFI 后，接入已有的 C 库，轻松太多。</p>
<p>设置一个小时更新一次，写入到数据库，真的是很无聊。</p>
<p>今天没时间了，后面粗糙的打算，是 H5 的前端工作，使用 Chart.js 将数据画成折线图，有了 sqlite 后，存储结构统一了，后面读取转成 JSON 应该就好，得看下什么时候有时间了。</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2019-08.html#p0">Permalink</a></div>

<div class="date">19年7月13日 周六 23:34</div>
<h2>gmp_ffi.lua</h2>
<p>上周考虑的 GMP LuaJIT FFI 绑定，最后将 GMP 的绝大部分函数接口导了出来变成了 <a href="https://github.com/lalawue/gmp_ffi">gmp_ffi</a>，包括整数、浮点、有理数、随机数，以及格式化输出，除了那些 C 直接输出文件包含 FILE * 的部分，后续也可以考虑将标准 C 库的文件操作函数也一并导出来。</p>
<p>另外，还将相关的初始化函数，通过 ffi.gc() 跟 finalizer 关联了起来，就不需要自己做相关的清理工作了。</p>
<p>还有，GMP 的 C 接口，其内部实现，都是带 __gmp 这样前缀的，即便通过 FFI 使用，也很不方便，所以 gmp_ffi 库，将这些接口都重新做了绑定，重命名为类似 mpz_mul() 这样的函数，跟 gmp.h 上通过 C 宏定义出来的接口一样使用。</p>
<p>有了上面的铺垫，一些好玩的东西可以搞起来，比如粗糙的计算素数的程序 <a href="https://github.com/lalawue/gmp_ffi/blob/master/test_prime.lua">test_prime.lua</a>，比如温习一下 RSA 加解密 <a href="https://github.com/lalawue/gmp_ffi/blob/master/test_rsa.lua">test_rsa.lua</a>，当前的实现是到处抄的，遥望大学时虽有做这个的大习题，但早就忘了，-.-</p>
<p>贴一下 gmp_ffi.lua 使用的例子吧：</p>
<pre lang="source"><code>local gmp = require(&quot;gmp_ffi&quot;)

function gmpffi_test()
   local a = gmp.mpz(11111111111)
   local b = gmp.mpz(&quot;999999999999999999999999999999999&quot;)
   local c = gmp.mpz(&quot;99999&quot;)
   gmp.mpz_mul(a, a, b)
   --gmp.mpz_set_ui(c, 1)
   gmp.printf(&quot;mpz: a:%Zd, c sign:&quot;, a)
   print(string.format(&quot;%d, odd:%s&quot;, gmp.mpz_sgn(c), gmp.mpz_odd(c)))
   a = gmp.mpz(&quot;ff&quot;, 16)
   gmp.printf(&quot;mpz: value base %Zx\n&quot;, a)

   a = gmp.mpf(111111111.111111111)
   b = gmp.mpf(&quot;999999999999999999999999999.99999999999999999999999999999999999&quot;)
   c = gmp.mpf(&quot;9999&quot;)
   gmp.mpf_mul(a, a, b)
   gmp.printf(&quot;mpf: %Ff, c sign:&quot;, a)
   print(gmp.mpf_sgn(c))

   a = gmp.mpq(111111111, 111111111)
   b = gmp.mpq(&quot;9999999999999999999999999999999/99999999999999999999999999999999999999&quot;)
   c = gmp.mpq(0)
   gmp.mpq_div(a, a, b)
   gmp.printf(&quot;mpq: %Qx, c sign:&quot;, a)
   print(gmp.mpq_sgn(c))

   local rt = gmp.randinit()
   local cs = gmp.cstring(64)
   gmp.sprintf(cs, &quot;random: %u&quot;, gmp.urandomb_ui(rt, 9999999))
   print(gmp.tostring(cs))
end

gmpffi_test()
</code></pre>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2019-07.html#p1">Permalink</a></div>

<div class="date">19年7月06日 周六 23:55</div>
<h2>LuaJIT FFI Library</h2>
<p>学习使用大数库，比如 <a href="https://gmplib.org/">GMP</a>，只是使用起来很糟心，比如大整数运算，先要 mpz_init() 最后回收时是 mpz_clear()，没错就是跟 malloc() 和 free() 一样的。就想着能不能稍微改善下易用性，用 C++ 是可以达到目的的，只是牛刀杀鸡，要走编译才能跑的还是太重了，而且 C++ 我也不熟。</p>
<p>就想着不如用 Lua 将其封装起来，之前的经验，是得自己写一个跟 Lua 虚拟机交互数据的接口，一个先进后出塞参数的栈，如果是要凑 table，还要复杂些。但如果使用 LuaJIT 的 FFI 库，就方便多了，具体在 BSD 这边是通过 dlsym 打开共享库，在 LuaJIT 脚本声明 C 接口后，通过 FFI 库直接调用。</p>
<p>能够支持各种 C 的函数接口，比如可变参数，以及各种数据类型，包括可变长度 struct 数据，甚至还有支持 Lua 侧的 gc 对于创建的 cdata 进行 finalizer，让 Lua 的 gc 只管理虚拟机这一侧 C 指针生命周期，API 文档是 <a href="http://luajit.org/ext_ffi_api.html">http://luajit.org/ext_ffi_api.html</a>。</p>
<h3>基本使用</h3>
<p>具体点的例子，比如声明并调用函数，创建一个 struct 结构，以及申请、释放内存的官方例子：</p>
<pre lang="source"><code>local ffi = require(&quot;ffi&quot;)

ffi.cdef[[
int printf(const char *fmt, ...); //声明并调用标准 C 库函数
typedef struct { uint8_t red, green, blue, alpha; } rgba_pixel; //struct 结构声明
]]

ffi.C.printf(&quot;Hello %s!&quot;, &quot;world&quot;)

-- 栈上 struct 结构
local img = ffi.new(&quot;rgbg_pixel[?]&quot;, 3)
img[0].green = 1

-- 创建、并释放外部内存对象
local p = ffi.gc(ffi.C.malloc(n), ffi.C.free)
...
p = nil -- Last reference to p is gone.
-- GC will eventually run finalizer: ffi.C.free(p)
</code></pre>
<h3>调用自定义库</h3>
<p>如果是自定义库，库路径需加入 LuaJIT 的 package.cpath 中，使用前 ffi.load('myffi') 一下，比如下面的例子看下 ffi.gc 是不是真的有用：</p>
<pre lang="source"><code>//#include &quot;stdio.h&quot;
//#include &quot;stdlib.h&quot;
void* test_malloc(int n) {
   void *p = malloc(n);
   printf(&quot;test_malloc %p:%d\n&quot;, p, n);
   return p;
}

void test_free(void *p) {
   printf(&quot;test_free %p\n&quot;, p);
   free(p);
}
</code></pre>
<p>先在本目录生成一个共享库：</p>
<pre lang="source"><code>clang -g -o libmyffi.dylib -fpic -shared myffi.c
</code></pre>
<p>在 LuaJIT 脚本侧这样使用：</p>
<pre lang="source"><code>local ffi = require(&quot;ffi&quot;)
local myffi = ffi.load(&quot;myffi&quot;)
ffi.cdef[[
void* test_malloc(int n);
void test_free(void *p);
]]
local p = ffi.gc(myffi.test_malloc(10), myffi.test_free)
print( p )
p = nil
</code></pre>
<p>会这样输出：</p>
<pre lang="example"><code>test_malloc 0x7f9962c027c0:10
cdata&lt;void *&gt;: 0x7f9962c027c0
test_free 0x7f9962c027c0
</code></pre>
<h3>使用 GMP 的例子</h3>
<p>先试一下 GMP 提供的大整数接口：</p>
<pre lang="source"><code>local ffi = require(&quot;ffi&quot;)
local gmp = ffi.load(&quot;gmp&quot;)

ffi.cdef[[
int printf(const char *fmt, ...);

typedef unsigned long long int	mp_limb_t;

typedef struct
{
  int _mp_alloc;		/* Number of *limbs* allocated and pointed
				   to by the _mp_d field.  */
  int _mp_size;			/* abs(_mp_size) is the number of limbs the
				   last field points to.  If _mp_size is
				   negative this is a negative number.  */
  mp_limb_t *_mp_d;		/* Pointer to the limbs.  */
} __mpz_struct;

typedef const __mpz_struct *mpz_srcptr;
typedef __mpz_struct *mpz_ptr;
typedef __mpz_struct mpz_t[1];

void __gmpz_init(mpz_ptr);
int __gmpz_set_str(mpz_ptr, const char *, int);
void __gmpz_mul(mpz_ptr, mpz_srcptr, mpz_srcptr);

void __gmpz_clear(mpz_ptr);
int __gmp_printf (const char *, ...);
]]

ffi.C.printf(&quot;input n1 x %s:\n&quot;, &quot;n2&quot;)

local arg1, arg2 = ...
if not arg or not arg2 then
   os.exit(0)
end

local n1 = ffi.new(&quot;mpz_t&quot;)
local n2 = ffi.new(&quot;mpz_t&quot;)
local n3 = ffi.new(&quot;mpz_t&quot;)

gmp.__gmpz_init(n1)
gmp.__gmpz_init(n2)
gmp.__gmpz_init(n3)

gmp.__gmpz_set_str(n1, arg1, 10)
gmp.__gmpz_set_str(n2, arg2, 10)

gmp.__gmpz_mul(n3, n1, n2)

gmp.__gmp_printf(&quot;n1 = %Zd\n&quot;, n1)
gmp.__gmp_printf(&quot;n2 = %Zd\n&quot;, n2)
gmp.__gmp_printf(&quot;n1 * n2 = %Zd\n&quot;, n3)

gmp.__gmpz_clear(n1)
gmp.__gmpz_clear(n2)
gmp.__gmpz_clear(n3)
</code></pre>
<p>输出是：</p>
<pre lang="example"><code>$ luajit test_ffi.lua 11111111111111111111111 99999999999999999999999999999999
input n1 x n2:
n1 = 11111111111111111111111
n2 = 99999999999999999999999999999999
n1 * n2 = 1111111111111111111111099999999988888888888888888888889
</code></pre>
<p>后面再看下怎么封装 GMP 的接口，毕竟这么使用，只是少了一次编译的时间，接口函数还是太复杂。</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2019-07.html#p0">Permalink</a></div>

<div class="date">19年6月22日 周六 13:05</div>
<h2>更新 ThisSite 描述</h2>
<p><a href="../scratch/ThisSite.html">scratch#ThisSite</a> 写于网站搭建的第一天，蛮有纪念意义的，虽然 UI 未变，但换了 rendering 工具后，相关描述也得添加进去，当初围绕 Emacs 构建的一整套知识管理工具（因为当时 Emacs 确实好玩），现在慢慢的变成 IDE 不再重要了。</p>
<p>不过本站中，我最喜欢的页面，当然还是 <a href="../muse/haha.html">muse#haha</a>，-.-</p>
<div class="category"><a href="CategoryThisSite.html">CategoryThisSite</a> / <a href="2019-06.html#p3">Permalink</a></div>

<div class="date">19年6月15日 周六 13:18</div>
<h2>WelcomePage 的生成</h2>
<p>之前博客首页 WelcomePage 的生成，是在 proj 的 prepare 阶段，通过获取最新月份数据，动态产生内容，之后通过 body 函数提供给 <a href="https://github.com/github/cmark-gfm">cmark-gfm</a> 来生成最终的 html。</p>
<p>这里带来的问题是，对应的 Permalink 是不准确的，指向到首页去了。</p>
<p>为了解决这个问题，只好在全部内容生成之后，再搜集首页需要的数据；另外一种解决的办法，是用在语法上对首页的 Permalink 做特别处理，但这样太复杂了。</p>
<p>最后，是给 <a href="https://github.com/lalawue/MarkdownProjectCompositor">MarkdownProjectCompositor</a> 中每个 proj 处理完所有 files 后，增加一个 after 处理函数，可以在最后，对生成内容做采集。</p>
<p>这样，首页的 Permalink 指向才是准确的。</p>
<p>还有，现在用 <a href="https://github.com/jbt/markdown-editor">markdown-editor</a> 来写感觉很不错啊，<a href="../images/markdown_editor.jpg">有图为例</a>。</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2019-06.html#p2">Permalink</a></div>
<!-- Page published by cmark-gfm ends here -->
<div id="foot">2004-<script type="text/javascript">var d = new
	Date();document.write(d.getFullYear())</script> &copy;
	Sucha. Powered by MarkdownProjectCompositor.
</div>
</div><!-- sidebar -->
  <div id="sidebar">
      <p class="header">Here</p>
      <ul>
        <li><a href="../index.html">Home</a></li>
        <li><a href="index.html">Front</a></li>
        <li><a href="../scratch/ThisSite.html">This Site</a></li>
        <li><a href="../live/AboutMe.html">About Me</a></li>
      </ul>

      <p class="header">Search</p><!-- Bing Search -->
      <form id="searchform" method="get" action="http://cn.bing.com/search" >
	<p><input id="searchtext" type="text" name="q" value="" /></p>
	<p><input type="hidden" name="ie" value="utf-8" /></p>
	<p><input type="hidden" name="oe" value="utf-8" /></p>
	<p><input type="hidden" name="hl" value="zh-CN" /></p>
	<p><input type="hidden" name="domains" value="suchang.net" /></p>
	<p><input name="si" type="hidden" value="suchang.net" /></p>
	<p><input type="hidden" name="sitesearch" value="suchang.net" /></p>
      </form>

      <p class="header">Contact</p>
        <ul>
          <li><a href="mailto:suchaaa@gmail.com">Mail me</a></li>
        </ul>

      <p class="header">Categories</p>

      <ul>
        <li><a href="CategoryLinux.html">GNU/Linux</a></li>
        <li><a href="CategoryProgramming.html">Programming</a></li>
        <li><a href="CategoryLife.html">Life &#38; essay</a></li>
        <li><a href="CategoryReading.html">Reading</a></li>
	<li><a href="CategoryThisSite.html">This Site</a></li>
        <li><a href="CategoryMisc.html">Misc</a></li>
      </ul>

      <p class="header">Links</p>
      <ul>
        <li><a href="http://blog.csdn.net/g9yuayon/">G9</a></li>
        <li><a href="http://www.ftchinese.com/column/007000002">朝九晚五</a></li>
        <li><a href="http://blog.codingnow.com/">CloudWu</a></li>
        <li><a href="http://www.google.cn/maps/@22.6273208,110.1513288,15540m/data=!3m1!1e3?hl=zh-CN">Yulin City</a></li>
      </ul>

      <p class="header">Archives</p><div class="archive_links"><ul><li><a href="2019-11.html">November 2019</a></li><li><a href="2019-10.html">October 2019</a></li><li><a href="2019-09.html">September 2019</a></li><li><a href="2019-08.html">August 2019</a></li><li><a href="2019-07.html">July 2019</a></li><li><a href="2019-06.html">June 2019</a></li><li><a href="2018-11.html">November 2018</a></li><li><a href="2018-09.html">September 2018</a></li><li><a href="2018-06.html">June 2018</a></li><li><a href="2018-05.html">May 2018</a></li><li><a href="2018-03.html">March 2018</a></li><li><a href="2018-01.html">January 2018</a></li><li><a href="2017-12.html">December 2017</a></li><li><a href="2017-09.html">September 2017</a></li><li><a href="2017-08.html">August 2017</a></li><li><a href="2017-06.html">June 2017</a></li><li><a href="2017-05.html">May 2017</a></li><li><a href="2017-04.html">April 2017</a></li><li><a href="2017-03.html">March 2017</a></li><li><a href="2017-02.html">February 2017</a></li><li><a href="2016-10.html">October 2016</a></li><li><a href="2016-05.html">May 2016</a></li><li><a href="2016-01.html">January 2016</a></li><li><a href="2015-12.html">December 2015</a></li><li><a href="2015-11.html">November 2015</a></li><li><a href="2015-10.html">October 2015</a></li><li><a href="2015-09.html">September 2015</a></li><li><a href="2015-08.html">August 2015</a></li><li><a href="2015-07.html">July 2015</a></li><li><a href="2015-06.html">June 2015</a></li><li><a href="2015-05.html">May 2015</a></li><li><a href="2015-03.html">March 2015</a></li><li><a href="2015-02.html">February 2015</a></li><li><a href="2015-01.html">January 2015</a></li><li><a href="2014-12.html">December 2014</a></li><li><a href="2014-05.html">May 2014</a></li><li><a href="2014-04.html">April 2014</a></li><li><a href="2014-03.html">March 2014</a></li><li><a href="2014-02.html">February 2014</a></li><li><a href="2014-01.html">January 2014</a></li><li><a href="2013-12.html">December 2013</a></li><li><a href="2013-11.html">November 2013</a></li><li><a href="2013-10.html">October 2013</a></li><li><a href="2013-09.html">September 2013</a></li><li><a href="2013-08.html">August 2013</a></li><li><a href="2013-07.html">July 2013</a></li><li><a href="2013-06.html">June 2013</a></li><li><a href="2013-05.html">May 2013</a></li><li><a href="2013-04.html">April 2013</a></li><li><a href="2013-03.html">March 2013</a></li><li><a href="2013-02.html">February 2013</a></li><li><a href="2013-01.html">January 2013</a></li><li><a href="2012-12.html">December 2012</a></li><li><a href="2012-11.html">November 2012</a></li><li><a href="2012-10.html">October 2012</a></li><li><a href="2012-08.html">August 2012</a></li><li><a href="2012-07.html">July 2012</a></li><li><a href="2012-06.html">June 2012</a></li><li><a href="2012-05.html">May 2012</a></li><li><a href="2012-04.html">April 2012</a></li><li><a href="2012-03.html">March 2012</a></li><li><a href="2012-02.html">February 2012</a></li><li><a href="2012-01.html">January 2012</a></li><li><a href="2011-12.html">December 2011</a></li><li><a href="2011-11.html">November 2011</a></li><li><a href="2011-10.html">October 2011</a></li><li><a href="2011-09.html">September 2011</a></li><li><a href="2011-08.html">August 2011</a></li><li><a href="2011-04.html">April 2011</a></li><li><a href="2011-02.html">February 2011</a></li><li><a href="2011-01.html">January 2011</a></li><li><a href="2010-12.html">December 2010</a></li><li><a href="2010-11.html">November 2010</a></li><li><a href="2010-09.html">September 2010</a></li><li><a href="2009-07.html">July 2009</a></li><li><a href="2009-06.html">June 2009</a></li><li><a href="2009-05.html">May 2009</a></li><li><a href="2009-04.html">April 2009</a></li><li><a href="2009-02.html">February 2009</a></li><li><a href="2009-01.html">January 2009</a></li><li><a href="2008-12.html">December 2008</a></li><li><a href="2008-11.html">November 2008</a></li><li><a href="2008-10.html">October 2008</a></li><li><a href="2008-09.html">September 2008</a></li><li><a href="2008-08.html">August 2008</a></li><li><a href="2008-07.html">July 2008</a></li><li><a href="2008-06.html">June 2008</a></li><li><a href="2008-05.html">May 2008</a></li><li><a href="2008-04.html">April 2008</a></li><li><a href="2008-03.html">March 2008</a></li><li><a href="2008-02.html">February 2008</a></li><li><a href="2008-01.html">January 2008</a></li><li><a href="2007-10.html">October 2007</a></li><li><a href="2007-07.html">July 2007</a></li><li><a href="2007-06.html">June 2007</a></li><li><a href="2007-05.html">May 2007</a></li><li><a href="2007-04.html">April 2007</a></li><li><a href="2007-03.html">March 2007</a></li><li><a href="2007-02.html">February 2007</a></li><li><a href="2007-01.html">January 2007</a></li><li><a href="2006-12.html">December 2006</a></li><li><a href="2006-11.html">November 2006</a></li><li><a href="2006-10.html">October 2006</a></li><li><a href="2006-09.html">September 2006</a></li><li><a href="2006-08.html">August 2006</a></li><li><a href="2006-07.html">July 2006</a></li><li><a href="2006-06.html">June 2006</a></li><li><a href="2006-05.html">May 2006</a></li><li><a href="2006-04.html">April 2006</a></li><li><a href="2006-03.html">March 2006</a></li><li><a href="2006-02.html">February 2006</a></li><li><a href="2006-01.html">January 2006</a></li><li><a href="2005-12.html">December 2005</a></li><li><a href="2005-11.html">November 2005</a></li><li><a href="2005-10.html">October 2005</a></li><li><a href="2005-09.html">September 2005</a></li><li><a href="2005-08.html">August 2005</a></li><li><a href="2005-07.html">July 2005</a></li><li><a href="2005-06.html">June 2005</a></li><li><a href="2005-05.html">May 2005</a></li><li><a href="2005-04.html">April 2005</a></li><li><a href="2005-03.html">March 2005</a></li><li><a href="2005-02.html">February 2005</a></li><li><a href="2005-01.html">January 2005</a></li><li><a href="2004-12.html">December 2004</a></li><li><a href="2004-11.html">November 2004</a></li><li><a href="2004-10.html">October 2004</a></li><li><a href="2004-09.html">September 2004</a></li></ul></div></div><!-- sidebar -->
   </div> <!-- body -->
  </body>
</html>