<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>Sucha's Blog - Welcome</title>
    <meta name="generator" content="MarkdownProjectCompositor.lua" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="Sucha" />
    <meta name="keywords" content="suchang, programming, GNU, Linux, Emacs, Lua" />
    <meta name="description" content="Sucha's blog" />
    <link rev="made" href="mailto:suchaaa@gmail.com" />
    <link rel="shortcut icon" href="../images/ico.png" />
    <link rel="stylesheet" type="text/css" href="../styles/blog.css" />
    <!--[if lte IE 6]><link rel="stylesheet" type="text/css" href="../styles/ie.css" /><![endif]-->
  </head>
  <body>
    <div id="body">
      <div id="text">
	<!-- Page published by cmark-gfm begins here --><h1>Sucha's Blog ~ Welcome</h1><div class="date">20年8月02日 周日 20:50</div>
<h2>做了一个 web 框架：cincau</h2>
<p>离职后在家呆了一个月，前面两周在休息，后面两周开始忙起来，想着将手头的数据搭一个可视化的网站出来，可以学习一下 web 前端的库之类的，但是呢，想找一个能 sqlite 和 nginx 的 web framework，找到一个感觉还可以的 <a href="https://github.com/sumory/lor">Lor</a>，但是呢，不支持 sqlite，感觉不算是一个 minimalist 的 web framework，就想着不如自己搭建一个吧。</p>
<p>可是如果搭建，顺便带上自己的 mnet 是肯定的了，当然 nginx 也是要支持的。于是参考了 lor 的不少东西，但更多的其实是自己摸索的，因为时间也比较充足，是先考虑了架构，才开始动手的。</p>
<p>没有浪费之前买的 goodnote 5，用来构思框架了，画了大概 5 个页面，大的模块上，跟 lor 一样，分为基础库，以及具体的项目代码。基础库在 /usr/local/cincau，用来生成基本的 demo 项目，本身包含了所有 proj 用到的的基础库。对上面的简单业务逻辑，封装 engine 层，不区分为 mnet 或者是 nginx，但实际上这两者一定是要区分开的，除非是静态的文件。</p>
<p>基础库里面，细分为 engine 层、router、MVC 逻辑、database、POST 的解析、HTTP Request 这几个部分，其中 MVC 中 view 的 rendering 用了 leafo 的 <a href="https://github.com/leafo/etlua">etlua</a>，这其实是基于 openresty 的 lapis 的一个模版库。database 不出意外，我只考虑了 sqlite3，就是 minimalist 的 web framework，等有需要，在考虑 mysql、postgresql 之类的，毕竟这两者，没有基于 mnet 的接口，只有基于 nginx 的。</p>
<p>在 goodnotes 5 上面花了 3、4 天这样，其实上面这么多细节，都是在完成整个项目后，回头才细化出来的。在草图出来以后，框架搭建花了大概一周，mnet 是基于 ffi_mnet.lua 以及 hyperparser 的回调，拿到 http 数据结构层。而 nginx 是 content_by_lua_file 来驱动的。</p>
<p>然后还继续花了 3、4 天来完善框架细节，比如 POST 以及 HTTP request 的那一套，以及基于这个框架，写了一个 demo project，支持 ment、nginx，包含静态页面、mock 的 model，以及 post x-www-urlencoded 和 multipart/form-data 这几个部分。</p>
<p>该放地址了：<a href="https://github.com/lalawue/cincau">cincau</a>，话说之前也断断续续做过半个 web framework，现在终于点连成了线，水到渠成了。</p>
<p>goodnote 5 画出来的框架图：</p>
<img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1gh9e9xgx85j20h00m00sv.jpg" width=360>
<img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1gh9e9xi8koj20h00m00t3.jpg" width=360>
<img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1gh9e9xq6k9j20h00m03yz.jpg" width=360>
<img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1gh9e9y00d1j20h00m0aam.jpg" width=360>
<img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1gh9e9xlayej20h00m00t2.jpg" width=360>
<img src="https://tva1.sinaimg.cn/mw690/6f6cc1c0gy1gh9e9xzu40j20h00m0t93.jpg" width=360>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2020-08.html#p0">Permalink</a></div>

<div class="date">20年7月25日 周四 11:22</div>
<h2>Curl 的 Lua 绑定，以及 multi 接口</h2>
<p>尝试了一下 curl 发送请求的 multi 接口，另外的 easy 接口是一个阻塞的设计，将 easy handle
放到 multi 中后，变成了非阻塞的接口。</p>
<p>大概是下面这样的逻辑，是非阻塞的，目前遇到的遗憾，是 perform 以及 wait 都没法知道具体是哪一个
easy handle 请求结束了。</p>
<pre lang="source"><code>easy = curl.easy()
easy:setopt(...) -- custom request header, response header, body reader
multi = curl.multi()
multi.add_handle(easy)
repeat
    multi.perform()
untile multi.wait() &lt;= 0
</code></pre>
<p>另外还试了一下 curl 中的 event-driven 接口，其实也还是 multi，但是区别于 multi.wait() 基于
底层 select 的设置，这里的 event-driven，依赖比如 libuv、libevent，以及我想集合进去的 mnet 的
事件循环。</p>
<p>创建这种 event-driven 的 curl 程序，还需要需要底层提供一个 timeout 的回调，也许是创建 socket connect 后，
回调具体的 fd，有了这个 fd 才能将其加入到 epoll、kqueue 里面去。</p>
<p>但是我自己验证的结果，感觉程序上跟 github 里面的 example 已经很像了，但一些请求没能成功。</p>
<p>这种方式需要设置好几个回调，在这个基础上设计中间件太复杂了，不管是输入的 header、post data，还是回调拿到 header、
body data 都太复杂了。</p>
<p>另外这种 event-driven 的方式还有一些隐含的条件，比如 timer 是独立于 fd 的，在 fd 前面就创建了，而且 timeout 的单位是 micro seconds，这其实是一个精度很高的 timer 了。</p>
<p>这里我也有疑惑，比如对于 curl 来说，这里的 event-driven 只是借用了 epoll、kqueue 的内核事件机制，我不大理解为何需要由 curl 来
创建 socket，为何不是更底层来管理 socket fd，其实参数交给 curl 来设置都可以，底层只是保证非阻塞就可以了。而 curl 更多的是面向 HTTP 这一层的中间件，raw data &lt;-&gt; HTTP structure data 的转换。</p>
<p>但不管怎么说，curl 这套东西还是太香了，毕竟每个发行版都有，每个发行版安装 dev 或者 command line tool 之后，有了头文件，就可以立马基于 libcurl 这个库进行发开发了。</p>
<p>因为自测 event-driven 没成功，相关信息也比较少，最后是用了上面 multi 接口包裹 easy 接口的非阻塞式设计，用了 <a href="https://github.com/Lua-cURL/Lua-cURLv3.git">Lua-cURLv3</a> 这个库，就请求而言，单独使用了 select。</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2020-07.html#p5">Permalink</a></div>

<div class="date">20年7月25日 周四 11:22</div>
<h2>HTML 的 Content-Type: multipart/form-data</h2>
<p>研究了一下，Mac 下轮着 Safari、Chrome、FireFox 前后台调通后，这里大概记录一下吧。</p>
<h3>前端页面 HTML</h3>
<p>在前端 HTML 的写法是，form 里面指定 enctype 为 &quot;multipart/form-data&quot;，如下</p>
<pre lang="source"><code>&lt;form class=&quot;cell&quot; action=&quot;&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;file&quot; name=&quot;myfile&quot; /&gt;
    &lt;input type=&quot;submit&quot; /&gt;
&lt;/form&gt;
</code></pre>
<h3>后端解析</h3>
<p>假设在浏览器里面点击 &quot;file&quot; 按钮，选择发送的是一个 PDF 文件，协议上收到是下面这样的，... 是省略：</p>
<pre lang="source"><code>POST /path HTTP/1.1
...
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary5WeF4Lu8GyQKEIE5
Accept-Language: zh-cn

------WebKitFormBoundary5WeF4Lu8GyQKEIE5
Content-Disposition: form-data; name=&quot;myfile&quot;; filename=&quot;noname.pdf&quot;
Content-Type: application/pdf

%PDF-1.3
...
%%EOF

------WebKitFormBoundary5WeF4Lu8GyQKEIE5--
</code></pre>
<p>我自己没有试过多文件，但是从网上资料看，多文件跟单文件不同的是，前面一个 boundary 结束符后，再来一个 boundary 的 Disposition 描述分割，开启下一个数据块的传输。</p>
<p>代码部分就不贴了，感觉有点挫，考虑了多文件分割，以及需要传递给用户文件名、类型等信息，最后是使用了阶段状态的描述，毕竟后端收到的数据是不定长的输入。</p>
<p>--</p>
<p>最后还是整了一下代码，加入了 builder，在 <a href="https://github.com/lalawue/multipart-formdata-lib">multipart-formdata-lib</a>.</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2020-07.html#p4">Permalink</a></div>

<div class="date">20年7月16日 周四 12:04</div>
<h2>LuaRocks with LuaJIT</h2>
<p>标准版的 LuaRocks 只有原版的 Lua 可以配套使用，torch 为了让 LuaRocks 能够支持 LuaJIT，修改了一个版本，其实只是修改了编译过程，毕竟 LuaJIT 完整支持 Lua 5.1 的语法。</p>
<p>torch 的版本支持 LuaJIT 的各个版本，但最新的只到 2.1 beta2。早上我将 LuaJIT 的支持版本升级到了 2.1 beta3，地址是 <a href="https://github.com/lalawue/luajit-rocks">luajit-rocks</a>，然后还发了一个 pull request。但是这个项目有好几年没有更新了，不晓得会不会有 maintainer 会注意到。</p>
<p>torch 的 luajit 其实还有修改 2 个地方，一个是 string 的 hash 方案，一个加入了交互用的 readline。交互部分明显有改善，而 hash 部分不晓得为什么要这么改，应该也还好吧，反正为了 pull request 这里我是不敢动的。hash 用的是 <a href="https://github.com/amadvance/tommyds">tommy 的方案</a>。</p>
<p>在 Linux 中编译了一把，顺利通过，后面再看需要安装吧。在自己的 MacBook Pro 上安装好后，install 了 busted 和 moonscript。不得不说，其实是为了试一下 moonscript，硬是找到了 LuaRocks 的 LuaJIT based 方案。</p>
<p>先用一阵子再说吧。</p>
<div class="category"><a href="CategoryMisc.html">CategoryMisc</a> / <a href="2020-07.html#p3">Permalink</a></div>

<div class="date">20年7月15日 周三 22:38</div>
<h2>MacOS 下使用 BitBar 在状态栏自定义信息</h2>
<p>如果自己有一些信息需要通过点击状态栏图标后获得，或者通过点击状态栏图标启动、关闭的，都可以使用这个工具 <a href="https://getbitbar.com">BitBar</a> 来操作。</p>
<p>安装好后，只需要定义 plugin 目录，然后在 plugin 目录下加入功能脚本就可以了。脚本其实只关注输出的文本，操作部分其实是通过特殊命令来定义的。</p>
<p>比如例子中的 refresh.sh，精简后是下面这样：</p>
<pre lang="source"><code>if [[ &quot;$1&quot; = &quot;restart&quot; ]]; then
osascript &lt;&lt;EOD
	tell application &quot;BitBar&quot; to quit
	delay 1
	tell application &quot;BitBar&quot; to activate
EOD
fi

echo &quot;↻&quot;
echo &quot;---&quot;
echo &quot;Refresh Me| terminal=false refresh=true&quot;
echo &quot;Restart Bitbar| bash='$0' param1=restart terminal=false&quot;;
</code></pre>
<p>会在状态栏显示一个圆圈刷新，点击后下拉菜单会有 &quot;Refresh Me&quot; 以及 &quot;Restart Bitbar&quot;。</p>
<ul>
<li>Refresh Me 是第一项，'|' 后定义功能动作，不新开一个 shell，刷新菜单</li>
<li>Restart Bitbar 是第二项，bash 定义使用到的脚本或者程序，‘$0' 就是 Bitbar 自己了，参数是 &quot;restart&quot;，其实是关闭然后再重启这个 refresh.sh，简简单单的 bash shell 语法了</li>
</ul>
<p>可惜的是我虽然弄懂了一点点如何编写这个 Bitbar 的 plugin 命令，但是通过 Bitbar 控制的程序最后没有符合我的预期，:-(</p>
<div class="category"><a href="CategoryLinux.html">CategoryLinux</a> / <a href="2020-07.html#p2">Permalink</a></div>

<div class="date">20年7月14日 周二 11:34</div>
<h2>GitHub 定义 Repo 语言</h2>
<p>之前写的 <a href="https://github.com/lalawue/LWTheme">LWTheme</a> 兼顾 Swift/ObjC 语言，GitHub 改版后，在 repo 里面没有语言百分比的显示了。</p>
<p>搜了一下，可以在 branch 里面定义 .gitattributes 文件，里面这样写</p>
<pre lang="source"><code>*.swift linguist-language=Swift
</code></pre>
<p>自测了一把，网站只会读取 default branch 里面的 .gitattributes，切换其他 branch 没有用。</p>
<div class="category"><a href="CategoryMisc.html">CategoryMisc</a> / <a href="2020-07.html#p1">Permalink</a></div>

<div class="date">20年7月9日 周四 15:44</div>
<h2>OpenVPN 配置记录</h2>
<p>其实考虑过几个比如 ShadowSocks 之类的，但是很不稳定，考虑最后也许还是用 VPN 来得稳妥一些，折腾了半天，终于跑通，先这里随便记录一下吧。</p>
<p>大概分两个部分，一个是服务端的配置，一个是客户端的配置。</p>
<ul>
<li>Ubuntu 下先 apt-get install openvpn</li>
<li>然后<a href="https://article.itxueyuan.com/pMy1b">生成服务端、客户端的密钥</a>，比如 ca、server key、client key、dh</li>
<li>接着<a href="http://blog.joylau.cn/2020/05/28/OpenVPN-Config/">服务端软件配置 server.config</a>，其实主要是上述密钥的配置，以及日志等文件位置，以及刚开始试运行时设置日志打印的密度</li>
<li>还有<a href="https://wiki.deepin.org/wiki/VPN%E6%9C%8D%E5%8A%A1">服务端系统配置</a>， 比如 iptables 配置转发</li>
<li>最后<a href="http://blog.joylau.cn/2020/05/28/OpenVPN-Config/">客户端软件配置</a>，大体上只是配置服务端 ip 地址，密钥就可以了</li>
</ul>
<p>客户端我在 Mac 下用的是 TunnelBlick，速度其实一般，还没长时间使用，后续先观察一阵。</p>
<div class="category"><a href="CategoryMisc.html">CategoryMisc</a> / <a href="2020-07.html#p0">Permalink</a></div>

<div class="date">20年6月21日 周日 11:39</div>
<h2>Text Rank 算法</h2>
<p><a href="https://web.eecs.umich.edu/~mihalcea/papers/mihalcea.emnlp04.pdf">TextRank</a> 是一种抽取式自动文摘算法，随便在网上搜一下相关，或者在 github 上面搜一下，介绍都一大把的。可是绝大部分的文章都只是堆 python 然后说要怎么做，也许是我的理解能力问题，在有限的几步里面，不晓得这么做的原因，会感觉很头疼。</p>
<p>这里尝试从大的方面还原这个算法，然后给出自己的实现，不过感觉自己的实现有些问题，效果没有想象中那么好，不过也总比没有强吧。</p>
<p>先开始吧。</p>
<p>TextRank 是一种抽取式的文章摘要算法，其最后的输出内容，都来源于文档本身的句子。这些句子会被算法打分排序，依靠的其实是 <a href="https://google.fandom.com/wiki/PageRank">PageRank</a> 算法。</p>
<h3>PageRank</h3>
<p>PageRank 算法原来只是为了描述网页间的重要程度，重要程度的计算，来源于他们间的超链接关系。简单的说，被链接得越多的页面，越重要，跟重要页面有链接的页面，比其他的页面更重要。准确分值的计算，是根据下面的公式来的：</p>
<p><img src="https://pic1.zhimg.com/80/v2-0d6c3c27eeee373e89b02e57630df6e4_720w.jpg" alt="img" /></p>
<p>其中，PR(Vi) 表示网页 Vi 的分值，In(Vi) 表示 PR(Vi) 包含的网页集合，Out(Vj) 表示 PR(Vi) 链接出去的网页集合，d 是链接传递系数或者说网页跳转的可能性，常用的值是 0.85。</p>
<p>可以把这个公式的计算基础描述成一张图，网页就是节点 PR(Vi)，边就是跟 PR(Vi) 有关系的 PR(Vj) 链接集合。</p>
<p>初始化的时候，各个 PR(Vi) 的分值是不确定的，只有边的链接描述，因此需要迭代计算，比如都给各个 PR(Vi) 初始化为 1，通过公式多轮不断的迭代计算，当各个 PR(Vi) 分值稳定的时候，就是各个网页的 rank 分值。</p>
<h3>Sentence simularity</h3>
<p>如果把上面的 PR(Vi) 当成句子，我们就可以套用 PageRank 公式计算出句子的 rank 值，并提取重要程度高的句子作为文章摘要描述。</p>
<p>但是如何确定不同的句子有边的联系呢，算法提供了计算句子间相似程度这个标准，使用下面的公式：</p>
<p><img src="https://pic4.zhimg.com/80/v2-6f2cdbb2e228a23d26ba303c9e958017_720w.jpg" alt="img" /></p>
<p>其中 wk 是句子 Si 及 Sj 都有的公共词组，分母是词组的数量。当然，也可以用句子的余弦相似度来计算，但是词组本身就得包含向量值了，这些词组，可以称为 word vector。</p>
<h3>Word Vector</h3>
<p>词组在中文里涉及到分词，有不同的工具可以用来分词表来构建语料的词向量表，比如有的用 <a href="https://pathmind.com/wiki/word2vec">word2vec</a>，有的用 <a href="https://nlp.stanford.edu/projects/glove/">GloVe</a>。话说，除了上面的模型、算法之外，语料可是相当重要的基础资源呀。</p>
<p>这里当然还涉及到使用哪些范畴的语料来构建这个 word vector，这里不详细叙述了，因为网上相关资源就更多了。</p>
<h3>最后</h3>
<p>TextRank 算法应该就是上面这些了吧，虽然为了搞清楚查了很久，最后推一把自己堆的 <a href="https://github.com/lalawue/text_rank">text_rank</a>，基于 LuaJIT 和 <a href="https://github.com/thunlp/THULAC">THULAC</a>，随便跑起来，内存就占用了 1 个 G，搞不起搞不起。</p>
<div class="category"><a href="CategoryStatistics.html">CategoryStatistics</a> / <a href="2020-06.html#p2">Permalink</a></div>

<div class="date">20年6月6日 周六 19:29</div>
<h2>Lua 的优点</h2>
<p>接着上一篇 <a href="../blog/2020-06.html#p0">Lua 的缺点</a>，作为平衡，这里补充一下。</p>
<p>作为一个普普通通，用过 ObjC、C/C++、Java、Swift、Emacs Lisp 的开发者，也是可以把 Lua 的一些好用的方面吹一下的。由于没用过 Python、Ruby、JavaScript，下面的观点未必就是 Lua 对比其他脚本语言鲜明的优点。</p>
<p>其实呢，我是将 Lua 跟上面所列的编译型、静态类型的语言做对比的，:)</p>
<h3>Lua 是简单的</h3>
<p>Lua 是命令式的语言，感觉以 C/C++、Java 起步的同学，学习 Lua 完全没有难度，Lua 语言没有几个关键字，控制结构甚至没有 continue。</p>
<p>而容器结构，只有一个 table，融合了 Array 以及 HashMap，当然，table 的作用不止于此，后面有更进一步的描述。</p>
<h3>Lua 很小易于移植</h3>
<p>Lua 语言只有核心部分，VM 代码只有几万行，是古老的 C89 语法，而且运行期的 VM 内存占用也不多，大概几百 kb 这样。</p>
<p>这使得 Lua 的编译安装是毫无难度的，支持 C89 的 C 编译器、硬件遍地都是。较少的资源消耗，意味着，在如今的操作系统上，可以大大方方的将几十、几百个 Lua VM 跑起来。</p>
<p>Lua 的核心还可以配置，将 Number 配置为 32bit 的 Integer，在低端没有浮点数的平台上，也能使用。好早之前，我就在 Rockchip 的的平台上应用上了 Lua，没有浮点数，Number 设置为了 32bit 的 Integer，用得好好的。</p>
<p>所以，不用担心写的纯 Lua 代码是不是在某些平台跑不起来，不存在的。</p>
<h3>Lua 很稳定很快</h3>
<p>Lua 生于 1993 年 7 月 28 日，语言核心早就稳定下来了，工业界早已采用多年。</p>
<p>LuaJIT 很快很快，可以看一下 LuaJIT-2.0 对比 Lua-5.1.5 版本的效率对比 <a href="http://luajit.org/performance_x86.html">Performance: x86/x64</a>。如今 Redis、OpenResty 标配 LuaJIT 作为内建的脚本支持。</p>
<h3>Lua 是动态类型的</h3>
<p>写应用程序的同学都了解，声明一个变量再去声明类型是有多重复，所以最新的 C++、Swift 对于类型都是可以自动推断的了。</p>
<p>我是觉得对于模块化设计来说，类型只在模块输入、输出的时候才有作用，比如对于输入的数据，我要知道变量的大小和范围，这也是模块对于这个输入参数声明的支持范围。</p>
<p>但如果真的需要程序关心内存布局的时候，每一个变量需要多大的内存空间，才值得去斟酌，而类型，其实就是内存空间占用的映射。模块内部，既然都是可信的环境，用足够大的内存区域去持有这个变量就行了，这个不影响，反而少了类似 C 这样因为类型转换而截断，导致期望的判断没有成功，引起模块内部错误，不得不抛出异常或者出错，其实毫无必要。</p>
<p>从另外一方面说，如果有了静态类型，可以控制任何一段程序在变量传递、比较时候的范围，但是当我们需要更高程度的抽象的时候，就又涉及到了如何抽象类型，这又涉及到了模版、范型。感觉又复杂了，也许这是所有静态类型的语言，都绕不过去的一个弯吧。</p>
<h3>Lua 支持多种编程模式</h3>
<p>Lua 中可以加载一段 String、一个文件并运行，简单的语法，使得数据描述编程、数据驱动编程是完全可行的。比如我在 Lua 脚本中加载自己，在运行前修改其流程，再运行，是完全可行的。</p>
<p>Lua 的函数是一等公民，可以实现 <a href="https://blog.csdn.net/yuanlin2008/article/details/8627081">lambada 算子</a>，函数式编程妥妥的没问题。</p>
<p>Lua 可以实现面向对象编程，上面有提到 table，当在 Lua 里面实现面向对象的时候，对象实例其实就是一个 table，对象的属性只不过是 table 里面的一个 key，函数跟 Number、String 一样可以作为 key 的 value。</p>
<p>当这样调用对象方法时，table:func(value)，func 默认第一个参数会传递 self，就是对象自己，一个 table，第二个参数才是 value。</p>
<p>理解 Lua 的面向对象编程，需要了解 Lua 内建的细节了，比如 table 的 __index key 是指找值的时候应该去哪里找，__newindex 则是创建新值的时候应该怎么做。多说一句，如果想 table 是 readonly 的，修改 table 的 __newindex 就对了。</p>
<p>下面是 Lua 的面向对象编程类定义的一个例子，a = Object.newObject(1), b = Object.newObject(2), a:isEqual(b) 将返回 false。</p>
<pre lang="source"><code>local Object = {
    value = 0
}
Object.__index = Object

function Object.newObject(value)
    local obj = setmetatable({}, Object)
    obj.value = value
    return obj
end

function Object:isEqual(obj)
    return self.value == obj.value
end

function Object:isGreater(obj)
    return self.value &gt; obj.value
end

return Object
</code></pre>
<p>更进一步，Lua 的面向对象可以定制 __index 来实现单继承，甚至多继承，实例变量、类变量等，面向对象用这个库就对了 <a href="https://github.com/kikito/middleclass/wiki">kikito/middleclass</a>。</p>
<h3>Lua 元表</h3>
<p>话说 table 在 Lua 中占据了中心位置，既是 Array 又是 HashMap，面向对象的时候又是对象实例本身，定义的时候用到了，实例运行期间也用到了。</p>
<p>table 有这么多的身份，定义不同身份时候的行为，成了关键。在 Lua 里面，table 的 key 怎么寻找，怎么设置新值，两个 table 之间怎么相加、相减等等，是通过定义 table 的 metatable （元表）来实现的。</p>
<p>面向对象的例子，就用了 Lua 的内建函数 setmetatable，定义了 Object.__index 的行为，限制 key 值应该在哪里寻找。</p>
<p>这里有一篇 <a href="https://www.runoob.com/lua/lua-metatables.html">Lua 元表</a> 的教程。</p>
<p>多说两句吧，结合面向对象 Object 的例子，我们定义一下两个 Object 相加的行为：</p>
<pre lang="source"><code>local Object = {}
Object.__index = Object
Object.__add = function(oobj, nobj)
    oobj.value = oobj.value + nobj.value
    return oobj
end
</code></pre>
<p>这样，如果 a = Object.newObject(1), b = Object.newObject(2), a = a + b 后，a.value 等于 3。</p>
<p>话说连 java 都没能实现的运算符重载，Lua 通过 table 的 metatable 实现了。</p>
<h3>Lua 跟 C 的交互</h3>
<p>官方 Lua 跟 C 的交互，需要用到 Lua 的 C API 定义 Lua 可以使用的 C 库，在这一层 wrapper 中再调用其他编译、链接进来的其他库，可以看下这篇 <a href="https://blog.csdn.net/AlexWoo0501/article/details/50916037">Lua C API 研究 —— 基础篇</a>，英文的 <a href="https://chsasank.github.io/lua-c-wrapping.html">Exposing C functions to Lua</a>。</p>
<p>如果用的是 LuaJIT，对于已有 C 库的使用，就方便多了，用到了内建的 ffi 库来声明二进制库中声明的函数接口、用到的结构等，官方教程及例子 <a href="http://luajit.org/ext_ffi_tutorial.html">FFI Tutorial</a>，这里不单独列举了。</p>
<p>--</p>
<p>Lua 作为一种简单、稳定、快速的命令式语言，提供高度的抽象，又可以很方便地使用已有的 C 库资源，对于我这种从 C/C++ 起步的程序员来说，相当友好。</p>
<p>酒醒了，吹一波不为过，:)</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2020-06.html#p1">Permalink</a></div>

<div class="date">20年6月5日 周五 23:56</div>
<h2>Lua 的缺点</h2>
<p>在官网的 <a href="https://www.lua.org/about.html">关于 Lua</a> 页面，是这么介绍 Lua 的：</p>
<pre lang="source"><code>Lua 是一种强大、高效、轻量，可嵌入的脚本语言。支持过程编程，面向对象编程，函数式编程，数据驱动编程，以及数据描述编程。
</code></pre>
<p>虽然 Lua 官网将自己介绍为脚本语言，但业界对于 Lua 的定位及使用早已超出普通脚本的范围。比如，<a href="https://wowwiki.fandom.com/wiki/Lua">魔兽争霸 3</a>，以及 Adobe 的 <a href="https://www.adobe.io/apis/creativecloud/lightroomclassic.html">Lightmoom</a> 都大量使用了 Lua 来构建桌面程序；在后端组件中大名鼎鼎的 Redis 以及 OpenResty，则将 Lua 作为了内嵌的业务处理语言；而在 github 上 star 数量为 9k 的 <a href="https://github.com/cloudwu/skynet">skynet</a>，则更进一步地将 Lua 定位为了后端的业务逻辑语言。</p>
<p>虽然 Lua 运行很快，业界的效率标杆 LuaJIT 是所有其他脚本语言用于比对的塔顶，要不然 Redis、OpenResty 怎会将其作为内嵌的扩展方案呢。</p>
<p>但是 Lua 并没有流行开来，对于一个创建于 1993 年 7 月 28 日的语言来说，缺的应该不是机遇，而是其他的一些东西。</p>
<p>我也用了不少时间的 Lua，作为一名普通的应用程序开发者，就吐槽一下吧。</p>
<h3>Lua 是分裂的</h3>
<p>Lua 是分裂的，不说别的，单就官方版本的 Lua 5.3.5 以及 LuaJIT，其实是两种不同的语言，LuaJIT 定在了 Lua 5.1.5 版本，且大量应用在了 Redis 以及 OpenResty 中。</p>
<p>而且因为 Lua 的核心很小，大量的功能都用 C 或者 C++ 构建，通过 C API 提供给 Lua 虚拟机调用，但是不同
的 Lua 版本，其实 C API 差异很大，几乎就是不同的语言。</p>
<p>很多将 Lua 作为嵌入脚本语言的的桌面程序，将其使用的 Lua 版本固定下来了，其 C API 构建的 Lua 库也都固定了，其他版本的 Lua 可不一定能使用上这个库，而这个提供给 Lua 使用的 C 库，也不是向前向后兼容的。</p>
<h3>Lua 是动态类型的</h3>
<p>这是一个双刃剑，这里只说不好的方面吧。如果一个变量是从 dofile() 函数中加载的，由于事先不知道类型，我无法知道这个变量的结构里面有哪些东西，在智能补全的 IDE 里面，将导致无法补全内容，也会将错误放到运行时才暴露。</p>
<h3>Lua 几乎没有官方的功能包</h3>
<p>由于定为为可嵌入的脚本语言，核心很小，基础的东西缺少太多了，比如</p>
<ul>
<li>网络库：官方没有网络库，最出名的 luasocket，其实效率不行的</li>
<li>图形库：官方没有任何平台的图形库</li>
<li>数据库：官方没有数据库的连接方案，网络库都没有，这个可以理解了</li>
<li>数学库：没有高精度的数学库</li>
</ul>
<p>仅有的语言核心，只有基本的输入输出，double 精度的数学操作而已。</p>
<h3>Lua 没有官方的包管理器</h3>
<p>Lua 没有官方的包管理器，这就导致了社区中好的库，应用实践，无法通过权威的渠道沉淀，并传递开来。随处可见普通的 Lua 用户将长时间将 Lua 作为普通的脚本语言，无法应用上顺手的包，解决眼前的问题。而对于高级一点的用户，也没有权威的渠道，来散播其创意和经验。</p>
<p>现有的官方的 <a href="http://lua-users.org/wiki/">Lua Users Wiki</a>，真的弱爆了。推一下 <a href="https://luarocks.org/">LuaRocks</a> 吧，还不错的。</p>
<h3>Lua 没有官方的 IDE</h3>
<p>IDE 是大大降低使用门槛的工具，也是大大提高开发效率的工具，结构化开发，断点调试，这些其他语言 IDE 中都有的东西，在 Lua 官方网站上，你是看不到的。</p>
<p>我自己倒是使用了 vs-code 配合 sumneko 的 <a href="https://github.com/sumneko/lua-language-server">lua-language-server</a> 插件，之前也看了一下 <a href="https://studio.zerobrane.com/">ZeroBrane</a> IDE，但没有用过。</p>
<h3>Lua 不支持多线程</h3>
<p>Lua 核心很小，C89 语法写成，没有规定运行平台，也就没有多线程支持这一说法了。</p>
<p>--</p>
<p>话说，喝了不少酒，吐了一下，舒服多了，:)</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2020-06.html#p0">Permalink</a></div>

<div class="date">20年5月23日 周六 08:56</div>
<h2>修改 m_net 在 Windows 下使用 ewpoll 作为底层事件通知</h2>
<p>之前 <a href="https://github.com/lalawue/m_net">m_net</a> 在 Windows 下是使用 select 作为 socket 事件检测接口，效率差是一方面，主要是其他更主要的服务端平台，比如 Linux/FreeBSD，以及开发常用的 MacOS，是另外一套相近的 API。</p>
<p>比如不管是 epoll 或者 kqueue，通过接口，可以返回一个当前时间片段内有事件发生的 socket 列表，以及 socket 对应的 ptr，用来绑定这个 socket 对应的内部结构。添加、删除 socket 事件列表的方法也相近。</p>
<p>然而 Windows 这边，因为用了线性的 select，内部数据结构映射方面，每次监听前，都得添加事件响应参数，又得单独处理，麻烦了很多。</p>
<p>后面介绍的这个 <a href="https://github.com/piscisaureus/wepoll">wepoll</a>，是在 Windows 下实现了 epoll 的接口，对那些志在跨平台的网络库来说，简单点只需要面对 epoll、kqueue 的区别就好了，而这两者很相近啊。</p>
<p>所以稍微修改了一下，m_net 就支持上了，另外还修复了一个大 bug，epoll_wait 接口的参数是 milliseconds 的，而 kqueue 的接口参数是 microseconds 的，fix 了一下。</p>
<p>然后跑了 test_reconnect、test_rwdata、test_timer 几个端对端的测试程序，完美应用。当然回头又跑了一遍 Linux、FreeBSD、MacOS 的下的端对端测试。</p>
<p>话说 <a href="https://github.com/piscisaureus/wepoll">wepoll</a> 在 Windows 下使用的也是 IOCP 对应的接口，不过没有使用到多线程，而是使用了 SetFileCompletionNotificationModes 函数取消端口操作完成后的异步通知，然后使用 NtDeviceIoControlFile 来获取端口的完成状态，这样就将异步事件转成同步的了。</p>
<p>另外一个部分，是将 epoll 相关接口的数据结构映射到 Windows 相关数据结构里面，大概就是这样。</p>
<p>很想说 NtDeviceIoControlFile 在 bing 上面都搜不到什么中文信息，蛋疼。</p>
<div class="category"><a href="CategoryProgramming.html">CategoryProgramming</a> / <a href="2020-05.html#p3">Permalink</a></div>
<!-- Page published by cmark-gfm ends here -->
<div id="foot">2004-<script type="text/javascript">var d = new
	Date();document.write(d.getFullYear())</script> &copy;
	Sucha. Powered by MarkdownProjectCompositor.
</div>
</div><!-- sidebar -->
  <div id="sidebar">
      <p class="header">Here</p>
      <ul>
        <li><a href="../index.html">Home</a></li>
        <li><a href="index.html">Front</a></li>
        <li><a href="../scratch/ThisSite.html">This Site</a></li>
        <li><a href="../live/AboutMe.html">About Me</a></li>
      </ul>

      <p class="header">Search</p><!-- Bing Search -->
      <form id="searchform" method="get" action="http://cn.bing.com/search" >
	<p><input id="searchtext" type="text" name="q" value="" /></p>
	<p><input type="hidden" name="ie" value="utf-8" /></p>
	<p><input type="hidden" name="oe" value="utf-8" /></p>
	<p><input type="hidden" name="hl" value="zh-CN" /></p>
	<p><input type="hidden" name="domains" value="suchang.net" /></p>
	<p><input name="si" type="hidden" value="suchang.net" /></p>
	<p><input type="hidden" name="sitesearch" value="suchang.net" /></p>
      </form>

      <p class="header">Contact</p>
        <ul>
          <li><a href="mailto:suchaaa@gmail.com">Mail me</a></li>
        </ul>

      <p class="header">Categories</p>

      <ul>
        <li><a href="CategoryLinux.html">GNU/Linux</a></li>
        <li><a href="CategoryProgramming.html">Programming</a></li>
        <li><a href="CategoryLife.html">Life &#38; essay</a></li>
        <li><a href="CategoryStatistics.html">Statistics</a></li>
        <li><a href="CategoryReading.html">Reading</a></li>
	     <li><a href="CategoryThisSite.html">This Site</a></li>
        <li><a href="CategoryMisc.html">Misc</a></li>
      </ul>

      <p class="header">Links</p>
      <ul>
        <li><a href="http://blog.csdn.net/g9yuayon/">G9</a></li>
        <li><a href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a></li>
        <li><a href="http://blog.codingnow.com/">CloudWu</a></li>
        <li><a href="http://www.google.cn/maps/@22.6273208,110.1513288,15540m/data=!3m1!1e3?hl=zh-CN">Yulin City</a></li>
      </ul>

      <p class="header">Archives</p><div class="archive_links"><ul><li><a href="2020-08.html">August 2020</a></li><li><a href="2020-07.html">July 2020</a></li><li><a href="2020-06.html">June 2020</a></li><li><a href="2020-05.html">May 2020</a></li><li><a href="2020-04.html">April 2020</a></li><li><a href="2020-02.html">February 2020</a></li><li><a href="2020-01.html">January 2020</a></li><li><a href="2019-12.html">December 2019</a></li><li><a href="2019-11.html">November 2019</a></li><li><a href="2019-10.html">October 2019</a></li><li><a href="2019-09.html">September 2019</a></li><li><a href="2019-08.html">August 2019</a></li><li><a href="2019-07.html">July 2019</a></li><li><a href="2019-06.html">June 2019</a></li><li><a href="2018-11.html">November 2018</a></li><li><a href="2018-09.html">September 2018</a></li><li><a href="2018-06.html">June 2018</a></li><li><a href="2018-05.html">May 2018</a></li><li><a href="2018-03.html">March 2018</a></li><li><a href="2018-01.html">January 2018</a></li><li><a href="2017-12.html">December 2017</a></li><li><a href="2017-09.html">September 2017</a></li><li><a href="2017-08.html">August 2017</a></li><li><a href="2017-06.html">June 2017</a></li><li><a href="2017-05.html">May 2017</a></li><li><a href="2017-04.html">April 2017</a></li><li><a href="2017-03.html">March 2017</a></li><li><a href="2017-02.html">February 2017</a></li><li><a href="2016-10.html">October 2016</a></li><li><a href="2016-05.html">May 2016</a></li><li><a href="2016-01.html">January 2016</a></li><li><a href="2015-12.html">December 2015</a></li><li><a href="2015-11.html">November 2015</a></li><li><a href="2015-10.html">October 2015</a></li><li><a href="2015-09.html">September 2015</a></li><li><a href="2015-08.html">August 2015</a></li><li><a href="2015-07.html">July 2015</a></li><li><a href="2015-06.html">June 2015</a></li><li><a href="2015-05.html">May 2015</a></li><li><a href="2015-03.html">March 2015</a></li><li><a href="2015-02.html">February 2015</a></li><li><a href="2015-01.html">January 2015</a></li><li><a href="2014-12.html">December 2014</a></li><li><a href="2014-05.html">May 2014</a></li><li><a href="2014-04.html">April 2014</a></li><li><a href="2014-03.html">March 2014</a></li><li><a href="2014-02.html">February 2014</a></li><li><a href="2014-01.html">January 2014</a></li><li><a href="2013-12.html">December 2013</a></li><li><a href="2013-11.html">November 2013</a></li><li><a href="2013-10.html">October 2013</a></li><li><a href="2013-09.html">September 2013</a></li><li><a href="2013-08.html">August 2013</a></li><li><a href="2013-07.html">July 2013</a></li><li><a href="2013-06.html">June 2013</a></li><li><a href="2013-05.html">May 2013</a></li><li><a href="2013-04.html">April 2013</a></li><li><a href="2013-03.html">March 2013</a></li><li><a href="2013-02.html">February 2013</a></li><li><a href="2013-01.html">January 2013</a></li><li><a href="2012-12.html">December 2012</a></li><li><a href="2012-11.html">November 2012</a></li><li><a href="2012-10.html">October 2012</a></li><li><a href="2012-08.html">August 2012</a></li><li><a href="2012-07.html">July 2012</a></li><li><a href="2012-06.html">June 2012</a></li><li><a href="2012-05.html">May 2012</a></li><li><a href="2012-04.html">April 2012</a></li><li><a href="2012-03.html">March 2012</a></li><li><a href="2012-02.html">February 2012</a></li><li><a href="2012-01.html">January 2012</a></li><li><a href="2011-12.html">December 2011</a></li><li><a href="2011-11.html">November 2011</a></li><li><a href="2011-10.html">October 2011</a></li><li><a href="2011-09.html">September 2011</a></li><li><a href="2011-08.html">August 2011</a></li><li><a href="2011-04.html">April 2011</a></li><li><a href="2011-02.html">February 2011</a></li><li><a href="2011-01.html">January 2011</a></li><li><a href="2010-12.html">December 2010</a></li><li><a href="2010-11.html">November 2010</a></li><li><a href="2010-09.html">September 2010</a></li><li><a href="2009-07.html">July 2009</a></li><li><a href="2009-06.html">June 2009</a></li><li><a href="2009-05.html">May 2009</a></li><li><a href="2009-04.html">April 2009</a></li><li><a href="2009-02.html">February 2009</a></li><li><a href="2009-01.html">January 2009</a></li><li><a href="2008-12.html">December 2008</a></li><li><a href="2008-11.html">November 2008</a></li><li><a href="2008-10.html">October 2008</a></li><li><a href="2008-09.html">September 2008</a></li><li><a href="2008-08.html">August 2008</a></li><li><a href="2008-07.html">July 2008</a></li><li><a href="2008-06.html">June 2008</a></li><li><a href="2008-05.html">May 2008</a></li><li><a href="2008-04.html">April 2008</a></li><li><a href="2008-03.html">March 2008</a></li><li><a href="2008-02.html">February 2008</a></li><li><a href="2008-01.html">January 2008</a></li><li><a href="2007-10.html">October 2007</a></li><li><a href="2007-07.html">July 2007</a></li><li><a href="2007-06.html">June 2007</a></li><li><a href="2007-05.html">May 2007</a></li><li><a href="2007-04.html">April 2007</a></li><li><a href="2007-03.html">March 2007</a></li><li><a href="2007-02.html">February 2007</a></li><li><a href="2007-01.html">January 2007</a></li><li><a href="2006-12.html">December 2006</a></li><li><a href="2006-11.html">November 2006</a></li><li><a href="2006-10.html">October 2006</a></li><li><a href="2006-09.html">September 2006</a></li><li><a href="2006-08.html">August 2006</a></li><li><a href="2006-07.html">July 2006</a></li><li><a href="2006-06.html">June 2006</a></li><li><a href="2006-05.html">May 2006</a></li><li><a href="2006-04.html">April 2006</a></li><li><a href="2006-03.html">March 2006</a></li><li><a href="2006-02.html">February 2006</a></li><li><a href="2006-01.html">January 2006</a></li><li><a href="2005-12.html">December 2005</a></li><li><a href="2005-11.html">November 2005</a></li><li><a href="2005-10.html">October 2005</a></li><li><a href="2005-09.html">September 2005</a></li><li><a href="2005-08.html">August 2005</a></li><li><a href="2005-07.html">July 2005</a></li><li><a href="2005-06.html">June 2005</a></li><li><a href="2005-05.html">May 2005</a></li><li><a href="2005-04.html">April 2005</a></li><li><a href="2005-03.html">March 2005</a></li><li><a href="2005-02.html">February 2005</a></li><li><a href="2005-01.html">January 2005</a></li><li><a href="2004-12.html">December 2004</a></li><li><a href="2004-11.html">November 2004</a></li><li><a href="2004-10.html">October 2004</a></li><li><a href="2004-09.html">September 2004</a></li></ul></div></div><!-- sidebar -->
   </div> <!-- body -->
  </body>
</html>